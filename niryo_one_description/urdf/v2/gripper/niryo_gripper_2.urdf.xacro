<?xml version="1.0"?>
<robot xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor" 
   xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller" 
   xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface" 
   xmlns:xacro="http://ros.org/wiki/xacro" name="egp_40">


   <xacro:macro name="cylinder_inertia" params="m r h">
      <inertia ixx="${m*(3*r*r+h*h)/12}" ixy = "0" ixz = "0" iyy="${m*(3*r*r+h*h)/12}" iyz = "0" izz="${m*r*r/2}" />
   </xacro:macro>

   <xacro:macro name="default_transmission" params="jname">
    <transmission name="${jname}_trans">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${jname}_joint">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
        <!--<hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
        <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>-->
      </joint>
      <actuator name="${jname}_motor">
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro>

   <xacro:macro name="niryo_gripper_2" params="prefix parent *origin">

      <joint name="${prefix}base_joint" type="fixed">
         <xacro:insert_block name="origin"/>
         <parent link="${parent}"/>
         <child link="${prefix}base_link"/>
      </joint>

      <!-- BASE LINK -->
      <link name="${prefix}base_link">
         <inertial>
            <mass value="0.25" />
            <origin xyz="0 0 0" />
            <cylinder_inertia m="0.20" r="0.05" h="0.05" />
         </inertial>

         <visual>
            <origin xyz="-0.01 0.02 0.05" rpy="0 3.14 3.14" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_MainSupport.STL" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="grey">
               <color rgba="0.5 0.5 0.5 1"/>
            </material>
         </visual>

         <collision>
            <origin xyz="-0.01 0.02 0.05" rpy="0 3.14 3.14" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_MainSupport.STL" scale="0.001 0.001 0.001"/>
            </geometry>
         </collision>
      </link>

      <gazebo reference="${prefix}base_link">
         <material>Gazebo/Black</material>
         <turnGravityOff>false</turnGravityOff>
      </gazebo>

      <!-- GEAR LEFT LINK -->
      <joint name="${prefix}gear_left_joint" type="revolute">
         <parent link="${prefix}base_link"/>
         <child link="${prefix}gear_left_link"/>
            <origin xyz="0.016 0 0.005" rpy="0 0 0" />
         <axis xyz="0 -1 0" />
 	 <limit effort="1000.0" lower="-1.2" upper="0.0" velocity="0.5"/>
      </joint>
      
      <gazebo reference="${prefix}gear_left_joint">
        <implicitSpringDamper>1</implicitSpringDamper>
      </gazebo>

      <link name="${prefix}gear_left_link">
         <inertial>
            <mass value="0.25" />
            <origin xyz="0 0 0" />
            <cylinder_inertia m="0.20" r="0.05" h="0.05" />
         </inertial>

         <visual>
         <origin xyz="-0.025 0.02 0.045" rpy="3.14 0.0 0.0" />

            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_GearLeft.STL" scale="0.001 0.001 0.001"/>
            </geometry>

            <material name="black">
  		<color rgba="0.0 0.0 0.0 1.0"/>
            </material>
         </visual>

         <collision>
            <origin xyz="0.0 0 0" rpy="0 0 0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_GearLeft.STL" scale="0.001 0.001 0.001"/>
            </geometry>
         </collision>
      </link>



      <!-- GEAR RIGHT LINK -->
      <joint name="${prefix}gear_right_joint" type="revolute">
         <parent link="${prefix}base_link"/>
         <child link="${prefix}gear_right_link"/>
         <origin xyz="-0.003 0 0.005" rpy="0 0.0 0.0" />
      <axis xyz="0 -1 0" />
 	 <limit effort="1000.0" lower="0" upper="1.2" velocity="0.5"/>
      </joint>
      
      <gazebo reference="${prefix}gear_right_joint">
        <implicitSpringDamper>1</implicitSpringDamper>
      </gazebo>

      <link name="${prefix}gear_right_link">
         <inertial>
            <mass value="0.25" />
            <origin xyz="0 0 0" />
            <cylinder_inertia m="0.20" r="0.05" h="0.05" />
         </inertial>

         <visual>
            <origin xyz="-0.008 0.02 0.045" rpy=" 3.14 0  0 " />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_GearRight.STL" scale="0.001 0.001 0.001"/>
            </geometry>

            <material name="black">
  		<color rgba="0.0 0.0 0.0 1.0"/>
            </material>
         </visual>

         <collision>
            <origin xyz="0.0 0 0" rpy="0 0 0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_GearRight.STL" scale="0.001 0.001 0.001"/>
            </geometry>
         </collision>
      </link>


      <!-- GRIPPER CLAMP LEFT -->

      <joint name="${prefix}left_finger_base_joint" type="revolute">
         <parent link="${prefix}gear_left_link"/>
         <child link="${prefix}left_finger_base_link"/>
            <origin xyz="0.01 0.0 0.035" rpy="0 0 0" />
         <axis xyz="0 -1 0" />
 	 <limit effort="1000.0" lower="-1.2" upper="1.2" velocity="0.5"/>
	<mimic joint="${prefix}gear_left_joint" multiplier="-1" offset="0"/>
      </joint>

      <gazebo reference="${prefix}left_finger_base_joint">
        <implicitSpringDamper>1</implicitSpringDamper>
      </gazebo>

   
      <link name="${prefix}left_finger_base_link">
         <inertial>
            <mass value="0.02" />
            <origin xyz="0 0 0" />
            <cylinder_inertia m="0.02" r="0.01" h="0.01" />
         </inertial>

         <visual>
            <origin xyz="-0.001 -0.007 0.011" rpy="0 3.14 0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Clamp.STL" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="black">
  		<color rgba="0.0 0.0 0.0 1.0"/>
            </material>
         </visual>

         <collision>
            <origin xyz="0.0 0 0" rpy="0 0 0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Clamp.STL" scale="0.001 0.001 0.001"/>
            </geometry>
         </collision>
      </link>




      <!-- GRIPPER CLAMP RIGHT -->
   

      <joint name="${prefix}right_finger_base_joint" type="revolute">
         <parent link="${prefix}gear_right_link"/>
         <child link="${prefix}right_finger_base_link"/>
         <origin xyz="-0.01 0.0 0.035" rpy=" 0 0 0" />
         <axis xyz="0 -1 0" />
 	 <limit effort="1000.0" lower="-1.2" upper="1.2" velocity="0.5"/>
	<mimic joint="${prefix}gear_right_joint" multiplier="-1" offset="0"/>
      </joint>


      <gazebo reference="${prefix}right_finger_base_joint">
        <implicitSpringDamper>1</implicitSpringDamper>
      </gazebo>
   
      <link name="${prefix}right_finger_base_link">
         <inertial>
            <mass value="0.02" />
            <origin xyz="0 0 0" />
            <cylinder_inertia m="0.02" r="0.01" h="0.01" />
         </inertial>

         <visual>
            <origin xyz="0.002 0.02 0.011" rpy="0 3.14 3.14" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Clamp.STL" scale="0.001 0.001 0.001"/>
            </geometry>
            <material name="black">
  		<color rgba="0.0 0.0 0.0 1.0"/>
            </material>
         </visual>

         <collision>
            <origin xyz="0.0 0 0" rpy="0 0 0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Clamp.STL" scale="0.001 0.001 0.001"/>
            </geometry>
         </collision>
      </link>



      <!-- ROD LEFT -->

      <joint name="${prefix}rod_left_joint" type="revolute">
         <parent link="${prefix}base_link"/>
         <child link="${prefix}rod_left_link"/>
            <origin xyz="0.014 0 0.027" rpy="0 0 0" />
        <axis xyz="0 -1 0" />
 	 <limit effort="1000.0" lower="-1.2" upper="1.2" velocity="0.5"/>
	<mimic joint="${prefix}gear_left_joint" multiplier="1" offset="0.0"/>
      </joint>
      
       <gazebo reference="${prefix}rod_left_joint">
        <implicitSpringDamper>1</implicitSpringDamper>
      </gazebo>

      <link name="${prefix}rod_left_link">
         <inertial>
            <mass value="0.25" />
            <origin xyz="0 0 0" />
            <cylinder_inertia m="0.20" r="0.05" h="0.05" />
         </inertial>

         <visual>
	<origin xyz="0.027 0.02 0.008" rpy="0.0 0.0 3.14" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Rod.STL" scale="0.001 0.001 0.001"/>
            </geometry>

            <material name="black">
  		<color rgba="0.0 0.0 0.0 1.0"/>
            </material>
         </visual>

         <collision>
            <origin xyz="0.0 0 0" rpy="0 0 0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Rod.STL" scale="0.001 0.001 0.001"/>
            </geometry>
         </collision>
      </link>



    
      <!-- ROD RIGHT -->

      <joint name="${prefix}rod_right_joint" type="revolute">
         <parent link="${prefix}base_link"/>
         <child link="${prefix}rod_right_link"/>
            <origin xyz="0.0 0 0.027" rpy="0 0 0" />
         <axis xyz="0 -1 0" />
 	 <limit effort="1000.0" lower="-1.2" upper="1.2" velocity="0.5"/>
	<mimic joint="${prefix}gear_right_joint" multiplier="1" offset="0.0"/>
      </joint>
      
      <gazebo reference="${prefix}rod_right_joint">
        <implicitSpringDamper>1</implicitSpringDamper>
      </gazebo>

      <link name="${prefix}rod_right_link">
         <inertial>
            <mass value="0.25" />
            <origin xyz="0 0 0" />
            <cylinder_inertia m="0.20" r="0.05" h="0.05" />
         </inertial>

         <visual>
	<origin xyz="-0.027 -0.007 0.008" rpy="0.0 0.0 0.0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Rod.STL" scale="0.001 0.001 0.001"/>
            </geometry>

            <material name="black">
  		<color rgba="0.0 0.0 0.0 1.0"/>
            </material>
         </visual>

         <collision>
            <origin xyz="0.0 0 0" rpy="0 0 0" />
            <geometry>
               <mesh filename="package://niryo_one_description/meshes/v2/stl/G2_Rod.STL" scale="0.001 0.001 0.001"/>
            </geometry>
         </collision>
      </link>


    <!-- Mimic joints -->
    <gazebo>
      <plugin filename="libgazebo_mimic_joint_plugin.so" name="${prefix}mimic_gripper2_1">
        <joint>${prefix}gear_left_joint</joint>
        <mimicJoint>${prefix}rod_left_joint</mimicJoint>
        <multiplier>1.0</multiplier>
        <offset>0.0</offset>
      </plugin>
      <plugin filename="libgazebo_mimic_joint_plugin.so" name="${prefix}mimic_gripper2_2">
        <joint>${prefix}gear_right_joint</joint>
        <mimicJoint>${prefix}rod_right_joint</mimicJoint>
        <multiplier>1.0</multiplier>
        <offset>0.0</offset>
      </plugin>
      <plugin filename="libgazebo_mimic_joint_plugin.so" name="${prefix}mimic_gripper2_3">
        <joint>${prefix}gear_left_joint</joint>
        <mimicJoint>${prefix}left_finger_base_joint</mimicJoint>
        <multiplier>-1.0</multiplier>
        <offset>0</offset>
      </plugin>
      <plugin filename="libgazebo_mimic_joint_plugin.so" name="${prefix}mimic_gripper2_4">
        <joint>${prefix}gear_right_joint</joint>
        <mimicJoint>${prefix}right_finger_base_joint</mimicJoint>
        <multiplier>-1.0</multiplier>
        <offset>0</offset>
      </plugin>
    </gazebo>


    <!-- hack from here: https://github.com/JenniferBuehler/gazebo-pkgs/wiki/The-Gazebo-grasp-fix-plugin -->
    <gazebo>
       <plugin name="gazebo_grasp_fix" filename="libgazebo_grasp_fix.so">
            <arm>
               <arm_name>niryo-arm</arm_name>
               <palm_link>hand_link</palm_link>
               <gripper_link>${prefix}left_finger_base_link</gripper_link>
               <gripper_link>${prefix}right_finger_base_link</gripper_link>
            </arm>
           <forces_angle_tolerance>100</forces_angle_tolerance>
           <update_rate>4</update_rate>
           <grip_count_threshold>4</grip_count_threshold>
           <max_grip_count>8</max_grip_count>
           <release_tolerance>0.005</release_tolerance>
           <disable_collisions_on_attach>false</disable_collisions_on_attach>
           <contact_topic>__default_topic__</contact_topic>
        </plugin>
    </gazebo>

    <xacro:default_transmission jname="${prefix}gear_left"/>
    <xacro:default_transmission jname="${prefix}gear_right"/>  

   </xacro:macro>

</robot>

